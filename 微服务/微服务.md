# 微服务

![image-20220605215159612](D:\project\笔记\微服务\pic\微服务架构.png)

## 简介

分布式架构面对的问题：

- 服务拆分的粒度
- 服务集群地址如何维护
- 服务之间如何实现远程调用
- 服务监控状态如何感知

微服务架构特征：

- 单一职责
- 面向服务：微服务对外暴露服务接口
- 自治：团队独立、技术独立、数据独立、部署独立

## 服务拆分

## 网关

### 核心功能

路由

权限控制

限流

## 服务保护

### **sentinel**整合

在微服务中引入依赖，并配置地址

### 雪崩问题

在服务调用的过程中，某个服务宕机导致直接或间接依赖关系的服务宕机的情况。

解决方案：

- 超时处理：设定超时时间
- 舱壁模式：限定每个业务能使用的线程数，避免耗尽tomcat的资源。
- 熔断降级：由断路器统计业务执行一场比例，超出一场会熔断该业务，拦截该业务的一切请求。
- 流量控制（预防）：限制业务访问的QPS，避免服务引流量地突增而故障.

#### 限流规则

流控模式：直接、关联、链路

#### 限流效果

快速失败：达到阈值后，对新的请求拒绝并抛出异常。

warm up：预热模式，对超出阈值的请求拒绝并抛出异常。

排队等待：让所有的请求按照先后次序排队执行，两个请求的间隔不能小于指定时长。

#### 隔离和降级

线程隔离（舱壁模式）：

1. 线程池：适合低扇出情况。支持主动超时和异步操作，但线程消耗大。

2. 信号量：适合高扇出情况，不支持主动超市和异步操作，无额外开销。

熔断降级：

断路器统计异常比例、慢请求比例，如果超出阈值则会熔断（拦截访问的一切请求）该服务，当服务恢复后，断路器放行访问该服务的请求。

#### 访问控制

网关添加请求头，sentinel通过 `RequestOriginParser`判断请求头。服务被调用方实现 `BlockException`返回异常，在请求头验证不通过的时候进行返回。
