# 并发

## 锁膨胀的时机

锁状态分为无锁、偏向锁、轻量级锁、重量级锁。

消耗越来越大，应保证使用合适的锁。默认从实现消耗最小的偏向开始，在当前锁不能应对当前运行需要的时候，发生锁膨胀。

一个对象实例化时，没有任何线程访问，此时它是可偏向的，当第一个一线程访问时，会通过CAS操作将其偏向该线程。

偏向锁的设想是基于在并发环境中，大多数时候是同一个线程多次访问该对象。所以当有其他线程尝试获取这个锁时，偏向模式立刻结束，持有线程仍然需要该资源，则会使偏向锁膨胀为轻量级锁。

轻量级锁的设想是认为竞争存在，但竞争程度很轻，一般两个线程不会竞争同一个锁，或者自旋一定时间，另一个线程就会释放锁。所以当自旋超过一定限度，或者又有第三个线程来访时，轻量级锁膨胀为重量级锁。

重量级锁会阻塞除拥有锁外的所有线程，防止CPU空转。